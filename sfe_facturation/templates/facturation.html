{% extends 'base.html' %}
{% load static %}
    
{% block content %}
    <div class="content-body">
      <div class="container-fluid">
        <div class="card">
          <div class="card-header d-sm-flex d-block">
            <div class="mr-auto mb-sm-0 mb-3">
              <a href="/facturation/?usr={{usr}}&com={{com}}"><h4 class="card-title mb-2">Toutes les factures </h4></a>
              <span class="ml-1" style="font-size: 12px;">Derni√®re mise √† jour le {{maj}}</span>
            </div>
            <div class="input-group search-area right d-lg-inline-flex d-none">
              <input type="text" class="form-control" placeholder="Rechercher une facture">
              <div class="input-group-append">
                <span class="input-group-text">
                  <a href="javascript:void(0)">
                    <i class="flaticon-381-search-2"></i>
                  </a>
                </span>
              </div>
            </div>
            <a href="javascript:void(0);" class="btn btn-info light mr-3 ml-3"><i class="las la-filter mr-2"></i>Filtre</a>
            <button type="button" class="btn btn-primary mb-2" data-toggle="modal" data-target="#md"><i class="las la-plus mr-2"></i>
                            Ajouter une facture 
                        </button>
                        <!-- modale  -->
                         <div class="modal fade" id="md">
                            <div class="modal-dialog modal-dialog-centered" style="margin-right: 0;">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Nouvelle facture</h5>
                                         <button type="button" class="close" data-dismiss="modal"><span>&times;</span> </button>
                                    </div>
                                    <div class="modal-body">
<form id="commandeForm" method="POST" action="{% url 'facture' %}">
  {% csrf_token %}
  <input type="hidden" name="usr" value="{{usr}}">
  <input type="hidden" name="com" value="{{com}}">
  <input type="hidden" name="jsonData" id="jsonData">

  <div class="card-body">
    <!-- CLIENT -->
    <div class="form-row mb-3">
      <div class="form-group col-md-6">
        <label for="client" class="form-label">Client</label>
        <select class="form-control default-select" id="client" name="client" required>
          <option value="">-- S√©lectionner --</option>
          {% for client in clients %}
            <option value="{{client.uuid}}">{{client.nom}}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group col-md-6">
        <label for="devise" class="form-label">Devise</label>
        <input type="text" class="form-control" id="devise" name="devise" value="{{entreprise.Devise}}" readonly>
      </div>
    </div>

  <div class="form-row mb-3">
    <div class="form-group col-md-6">
      <label for="mode" class="form-label">Mode</label>
      <select class="form-control default-select" id="mode" name="mode" required>
        <option value="ttc">TTC</option>
        <option value="ht">HT</option>
      </select>
    </div>

    <div class="form-group col-md-6">
      <label for="type_facture" class="form-label">Type de facture</label>
      <select class="form-control default-select" id="type_facture" name="type_facture" required>
          <option value="">-- S√©lectionner --</option>
          <option value="FV">Facture de vente</option>
          <option value="FA">Facture d'avoir</option>
      </select>
    </div>
  </div>
  <div class="form-row" id="factureAvoirFields" style="display:none;">
    <div class="form-row">
        <div class="form-group col-md-6">
          <label for="nature">Nature</label>
          <input type="text" class="form-control" id="nature" name="nature" placeholder="Nature de la facture">
        </div>
        <div class="form-group col-md-6">
          <label for="reference" class="form-label">R√©f√©rence</label>
          <input type="text" class="form-control" id="reference" name="reference" placeholder="N¬∞ de facture concern√©e">
        </div>
    </div>
  </div>

    <!-- TABLE DES ARTICLES -->
    <div class="table-responsive">
      <table class="table primary-table-bordered mb-3" id="articlesTable">
        <thead class="thead-light px-2">
          <tr>
            <th style="font-size: 10px;">Article</th>
            <th style="font-size: 10px;">Prix HT</th>
            <th style="font-size: 10px;">Quantit√©</th>
            <th style="font-size: 10px;">Groupe</th>
            <th style="font-size: 10px;">Total [TTC]</th>
            <th style="font-size: 10px;">Action</th>
          </tr>
        </thead>
        <tbody id="articlesBody">
          <tr>
            <td>
              <select class="article-name" name="article" required>
                <option value="">-- S√©lectionner --</option>
                {% for article in articles %}
                  <option 
                    value="{{article.uuid}}" 
                    data-price="{{article.prixht}}" 
                    data-groupe-label="[{{article.code_groupe}}]{{article.taux_groupe}}%" 
                    data-groupe-taux="{{article.taux_groupe}}"
                  >
                    {{article.nom}}
                  </option>
                {% endfor %}
              </select>
            </td>
            <td><input type="number" class="price" min="0" step="any" value="0" style="width: 65px;" readonly></td>
            <td><input type="number" class="qty" min="1" value="1" style="width: 65px;"></td>
            <td><input type="text" class="groupe" style="width: 65px;" readonly></td>
            <td class="lineTotal"><div style="width: 70px;"> 0 </div></td>
            <td>
              <button type="button" class="btn btn-danger btn-sm removeRow">
                <svg width="20" height="20" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 6H5H21" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                  <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <button type="button" class="btn btn-info btn-sm mt-3" id="addRow">
      <i class="las la-plus mr-2"></i>Ajouter un article
    </button>

    <!-- TOTALS G√âN√âRAUX -->
    <div class="mt-4 text-right">
      <h5>Total HT : <span id="totalHT" class="text-primary fw-bold">0 USD</span></h5>
      <h5>Total TTC : <span id="totalTTC" class="text-success fw-bold">0 USD</span></h5>
    </div>

    <!-- COMMENTAIRE -->
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="paiement" name="paiement">
      <label class="form-check-label" for="paiement">Commentaire</label>
    </div>

    <div id="paiementSection" class="border p-3 mb-3" style="display:none;">
      <textarea class="form-control" rows="4" id="comment" name="comment"></textarea>
    </div>

    <div class="card-footer d-sm-flex justify-content-between align-items-center">
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal">Valider la facture</button>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal fade" id="modal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmation</h5>
        </div>
        <div class="modal-body">
          <p>Voulez-vous vraiment g√©n√©rer la facture et lancer son processus de normalisation ? Cette action est irr√©versible et transmettra √† la DGI toutes les donn√©es relatives √† la facture.</p>
        </div>
        <div class="modal-footer">
          <div class="text-end">
            <button type="submit" class="btn btn-danger light px-4">Continuer</button>
          </div>
          <a href="/facturation/?usr={{usr}}&com={{com}}" class="btn btn-primary px-4 mt-2" data-dismiss="modal">Annuler</a>
        </div>
      </div>
    </div>
  </div>
</form>

</div>
</div>
</div>
</div>


<!-- SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const tableBody = document.getElementById('articlesBody');
  const totalHTDisplay = document.getElementById('totalHT');
  const totalTTCDisplay = document.getElementById('totalTTC');
  const deviseSelect = document.getElementById('devise');
  const form = document.getElementById('commandeForm');
  const typeFacture = document.getElementById('type_facture');
  const factureAvoirFields = document.getElementById('factureAvoirFields');

  // Afficher les champs "Nature" et "R√©f√©rence"
  typeFacture.addEventListener('change', () => {
      const isAvoir = typeFacture.value === "FA";
      factureAvoirFields.style.display = isAvoir ? 'block' : 'none';
      toggleRequiredFields(factureAvoirFields, isAvoir);
  });

  // Fonction pour rendre obligatoires les champs visibles
  function toggleRequiredFields(section, isRequired) {
      const inputs = section.querySelectorAll('input, select');
      inputs.forEach(el => el.required = isRequired);
  }

  // üîπ Fonction de calcul des totaux
  function updateTotals() {
    let totalHT = 0;
    let totalTTC = 0;
    const devise = deviseSelect.value || 'USD';

    tableBody.querySelectorAll('tr').forEach(row => {
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const qty = parseFloat(row.querySelector('.qty').value) || 0;
      const taux = parseFloat(row.querySelector('.groupe').dataset.taux) || 0;

      const montantHT = price * qty;
      const montantTTC = montantHT + (montantHT * taux / 100);

      totalHT += montantHT;
      totalTTC += montantTTC;

      row.querySelector('.lineTotal').textContent = montantTTC.toLocaleString('fr-FR');
    });

    totalHTDisplay.textContent = totalHT.toLocaleString('fr-FR') + ' ' + devise;
    totalTTCDisplay.textContent = totalTTC.toLocaleString('fr-FR') + ' ' + devise;
  }

  // üîπ Ajout d'une nouvelle ligne
  document.getElementById('addRow').addEventListener('click', () => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select class="article-name" name="article" required>
          <option value="">-- S√©lectionner --</option>
          {% for article in articles %}
            <option 
              value="{{article.uuid}}" 
              data-price="{{article.prixht}}" 
              data-groupe-label="[{{article.code_groupe}}]{{article.taux_groupe}}%" 
              data-groupe-taux="{{article.taux_groupe}}"
            >
              {{article.nom}}
            </option>
          {% endfor %}
        </select>
      </td>
      <td><input type="number" class="price" min="0" step="any" value="0" style="width: 65px;" readonly></td>
      <td><input type="number" class="qty" min="1" value="1" style="width: 65px;"></td>
      <td><input type="text" class="groupe" style="width: 65px;" readonly></td>
      <td class="lineTotal">0</td>
      <td>
        <button type="button" class="btn btn-danger btn-sm removeRow">
          <svg width="20" height="20" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 6H5H21" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
      </td>
    `;
    tableBody.appendChild(tr);
    updateTotals();
  });

  // üîπ Suppression d'une ligne
  tableBody.addEventListener('click', e => {
    if (e.target.closest('.removeRow')) {
      e.target.closest('tr').remove();
      updateTotals();
    }
  });

  // üîπ Mise √† jour des totaux quand quantit√© change
  tableBody.addEventListener('input', e => {
    if (e.target.classList.contains('qty')) updateTotals();
  });

  // üîπ S√©lection d‚Äôarticle ‚Üí remplissage automatique du prix et du groupe
  tableBody.addEventListener('change', e => {
    if (e.target.classList.contains('article-name')) {
      const selected = e.target.selectedOptions[0];
      const price = selected.getAttribute('data-price');
      const label = selected.getAttribute('data-groupe-label');
      const taux = selected.getAttribute('data-groupe-taux');
      const row = e.target.closest('tr');

      row.querySelector('.price').value = price || 0;
      const groupeInput = row.querySelector('.groupe');
      groupeInput.value = label || '';
      groupeInput.dataset.taux = taux || 0;

      updateTotals();
    }
  });

  // üîπ Changement de devise ‚Üí r√©affichage des totaux
  deviseSelect.addEventListener('change', updateTotals);

  // üîπ Section commentaire
  const paiementCheckbox = document.getElementById('paiement');
  const paiementSection = document.getElementById('paiementSection');
  paiementCheckbox.addEventListener('change', () => {
    paiementSection.style.display = paiementCheckbox.checked ? 'block' : 'none';
  });

  // üîπ Soumission du formulaire ‚Üí g√©n√©ration du JSON brut
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const client = { uuid: document.getElementById('client').value };
    const devise = deviseSelect.value;
    const items = [];
    let totalHT = 0;
    let totalTTC = 0;

    tableBody.querySelectorAll('tr').forEach(row => {
      const article = row.querySelector('.article-name').value;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const qty = parseFloat(row.querySelector('.qty').value) || 0;
      const groupe_label = row.querySelector('.groupe').value;
      const groupe_taux = parseFloat(row.querySelector('.groupe').dataset.taux) || 0;

      if (article && qty > 0) {
        const lineTotalHT = price * qty;
        const lineTotalTTC = lineTotalHT + (lineTotalHT * groupe_taux / 100);
        totalHT += lineTotalHT;
        totalTTC += lineTotalTTC;

        items.push({ article, price, qty, groupe_label, groupe_taux, lineTotalHT, lineTotalTTC });
      }
    });

    if (items.length === 0) {
      alert("Veuillez ajouter au moins un article √† la commande !");
      return;
    }

    const data = { client, devise, items, totalHT, totalTTC };

    document.getElementById('jsonData').value = JSON.stringify(data);
    console.log("üì¶ Donn√©es envoy√©es :", data);
    form.submit();
  });
});
</script>


          </div>
        </div>
    {% block paiement %}
      {% if not message == ''%}      
          <div class="card-body text-center">
            <div id="accordion-two" class="accordion accordion-danger-solid">
              <div class="accordion__item">
                  <div class="accordion__header" data-toggle="collapse" data-target="#bordered_collapseOne"> <span class="accordion__header--text">{{titre}}</span>
                      <span class="accordion__header--indicator"></span>
                  </div>
                  <div id="bordered_collapseOne" class="collapse accordion__body show" data-parent="#accordion-two">
                      <div class="accordion__body--text">
                          {{message}}
                      </div>
                  </div>
              </div>
            </div>
          </div>
      {% endif %}
      {% if nbr == 0 %}
        <div class="card">			
					<div class="card-body text-center">
          <p>Aucune facture trouv√©e</p>
          </div>
        </div>  
      {% else %}
        <div class="row">
        {% for i in commandes %}
          <div class="col-xl-6 col-lg-12">
            <div class="card project-card">
              <div class="card-body">
                <div class="d-flex mb-4 align-items-start">
                  <div class="dz-media mr-3">
                    <a href="#" class="text-black"><img src="{% static i.profil_client %}" class="img-fluid" alt=""></a>
                  </div>
                  <div class="mr-auto">
                    <a href="/sfe_facturation/static/media/{{i.uuid}}.pdf" class="text-primary mb-1" style="font-size: 12px;">{{i.code}}</a>
                    <h5 class="title font-w600 mb-2">{{i.client}}</h5>
                    <span>{{i.type_client}}</span>
                  </div>
                  <a href="/detail/?usr={{usr}}&com={{com}}&code={{i.uuid}}"><span class="badge badge-info mr-2">
                    <i  class="las la-eye" ></i>
                  </a>
                  <a href="/mails/?usr={{usr}}&com={{com}}&destination={{i.id_client}}"><span class="badge badge-primary">
                    <i class="fa fa-envelope-o"></i>
                  </a>
                </div></a>
                <div class="row mb-4">
                  <div class="col-sm-6 mb-sm-0 mb-3 d-flex">
                    <div class="dt-icon bgl-info mr-3">
                      <svg width="24" height="24" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 5H18V3C18 2.73478 17.8946 2.48043 17.7071 2.29289C17.5196 2.10536 17.2652 2 17 2C16.7348 2 16.4804 2.10536 16.2929 2.29289C16.1054 2.48043 16 2.73478 16 3V5H8V3C8 2.73478 7.89464 2.48043 7.70711 2.29289C7.51957 2.10536 7.26522 2 7 2C6.73478 2 6.48043 2.10536 6.29289 2.29289C6.10536 2.48043 6 2.73478 6 3V5H5C4.20435 5 3.44129 5.31607 2.87868 5.87868C2.31607 6.44129 2 7.20435 2 8V9H22V8C22 7.20435 21.6839 6.44129 21.1213 5.87868C20.5587 5.31607 19.7957 5 19 5Z" fill="#92caff"></path>
                        <path d="M2 19C2 19.7956 2.31607 20.5587 2.87868 21.1213C3.44129 21.6839 4.20435 22 5 22H19C19.7957 22 20.5587 21.6839 21.1213 21.1213C21.6839 20.5587 22 19.7956 22 19V11H2V19Z" fill="#51A6F5"></path>
                      </svg>
                    </div>
                    <div>
                      <span>Date</span>
                      <p class="mb-0 pt-1 font-w500 text-black">{{i.date}}</p>
                    </div>
                  </div>
                  <div class="col-sm-6 d-flex">
                    <div class="dt-icon mr-3 bgl-danger">
                      <i class="flaticon-381-network" style="font-size: 20px;"></i>
                    </div>
                    <div>
                      <span>Articles</span>
                      <p class="mb-0 pt-1 font-w500 text-black">{{i.nbr_articles}} item(s)</p>
                    </div>
                  </div>
                </div>
                <div class="d-flex flex-wrap align-items-center">
                  <div class="d-flex align-items-center mb-4">
                    <div class="text-center border-bx mr-3">
                      <span>Total</span>
                      <p class="mb-0 pt-1 font-w500 text-black">{{i.total}} {{i.devise}}</p>
                    </div>
                    <div class="text-center border-bx">
                      <span>Pay√©</span>
                      <p class="mb-0 pt-1 font-w500 text-black">{{i.paye}} {{i.devise}}</p>
                    </div>
                    <div class="ml-3 text-center border-bx">
                      <span>Solde</span>
                      <p class="mb-0 pt-1 font-w500 text-black">{{i.solde}} {{i.devise}}</p>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <div>Quantit√©:<span class="text-black ml-3 font-w600">{{i.quantite}}</span></div>
                    <div>Paiements:<span class="text-black ml-3 font-w600">{{i.nbr_paies}}</span></div>
                  </div>
                  <div class="col-6">
                    <h6>Progression
                      <span class="pull-right">{{i.progression}}%</span>
                    </h6>
                    <div class="progress ">
                    {% if i.progression < 25 %}
                      <div class="progress-bar bg-danger progress-animated" style="width: {{i.progression}}%; height:6px;" role="progressbar"></div>
                    {% elif i.progression < 50 %}
                      <div class="progress-bar bg-primary progress-animated" style="width: {{i.progression}}%; height:6px;" role="progressbar"></div>
                    {% elif i.progression < 75 %}
                      <div class="progress-bar bg-info progress-animated" style="width: {{i.progression}}%; height:6px;" role="progressbar"></div>
                    {% else %}
                      <div class="progress-bar bg-success progress-animated" style="width: {{i.progression}}%; height:6px;" role="progressbar"></div>
                    {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
        </div>
      {% endif %}
    {% endblock %}
      </div>
    </div>

{% endblock %}