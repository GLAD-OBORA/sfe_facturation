{% extends 'liste-article.html' %}
{% load static %}
		

{% block article %}
	<div class="card">			
		<div class="card-body">
			<div class="modal-header">
				<a href="/articles/?usr={{usr}}&com={{com}}" class="close"><span>&times;</span> </a>
			</div>
			<div class="card-body">
				<div class="text-center">
					<div class="my-profile">
						<img src="{% static article.photo %}" alt="" class="rounded">
						<a href="#" role="button" data-toggle="modal" data-target="#cameraModal"><i class="fa fa-pencil" aria-hidden="true"></i></a>
						<!-- Modal -->
						<div class="modal fade" id="cameraModal">
							<div class="modal-dialog modal-dialog-centered" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title">Importer une photo</h5>
										<button type="button" class="close" data-dismiss="modal"><span>&times;</span>
										</button>
									</div>
									<div class="modal-body">
									<form action="{% url 'photo_article' %}" method="post" enctype="multipart/form-data">
										{% csrf_token %}
										<input type="hidden" name="usr" value="{{usr}}">
										<input type="hidden" name="com" value="{{com}}">
										<input type="hidden" name="article_id" value="{{article.uuid}}">
										<div class="input-group mb-3">
											<div class="input-group-prepend">
												<button class="input-group-text" type="submit">Valider</button>
											</div>
											<div class="custom-file">
												<input type="file" class="custom-file-input" id="fileInput" accept="image/*" name="photo" required>
												<label class="custom-file-label">Choisir un fichier</label>
											</div>
										</div>
									</form>
									</div>
								</div>
							</div>
						</div>
					</div>
					<p class="text-danger mt-2">{{message}}</p>
					<h4 class="mt-3 font-w600 text-black mb-0 name-text">{{article.nom}}</h4>
					<span>[{{article.type}}]</span>
					<p class="mb-0 mt-2">Dernière mise à jour le {{article.date}}</p>
				</div>
				<ul class="portofolio-social">
					<li><a href="/detail_article/?usr={{usr}}&com={{com}}&article={{i.uuid}}"><i class="fa fa-eye"></i></a></li>
					<li><a href="#" role="button" data-toggle="modal" data-target="#modalConfirm"><i class="fa fa-trash"></i></a>
							<div class="modal fade" id="modalConfirm">
									          <div class="modal-dialog modal-dialog-centered" style="max-width: 50vw">
									              <div class="modal-content">
									                <div class="modal-header">
									                  <h5 class="modal-title">Confirmation</h5>
									                  <button type="button" class="close" data-dismiss="modal"><span>&times;</span> </button>
									                </div>
									                <div class="modal-body">
                                    <p>Voulez-vous vraiment supprimer l'article <strong>{{article.nom}}</strong> ? Cette action est irrersible et elle entrainera : <br><br> La suppression dudit article dans tous les devis et factures, ce qui affectera toutes les statistiques financières.</p>
                                  </div>
                                  <div class="modal-footer">
													          <form id="formArticle" action="{% url 'delete_article' %}" method="post">
													            <div class="mb-3">
													            	{% csrf_token %}
													              <input type="hidden" name="usr" value="{{usr}}">
													              <input type="hidden" name="com" value="{{com}}">
													              <input type="hidden" name="article_id" value="{{article.uuid}}">
													            </div>
													            <div class="text-end">
													              <button type="submit" class="btn btn-danger light px-4">Supprimer</button>
													          </form>
													            </div>
													          		<button type="button" class="btn btn-primary px-4 mt-2" data-dismiss="modal">Annuler</button>
									               </div>
									           </div>
									       </div>
									     </div></li>
				</ul>
			</div>
				<div class="card">
                                  
                                    <div class="card-body">
                                
       
          <form id="formArticle" action="{% url 'infos_article' %}" method="post"> 
  {% csrf_token %}
  <input type="hidden" name="usr" value="{{usr}}">
  <input type="hidden" name="com" value="{{com}}">
  <input type="hidden" name="article_id" value="{{article.uuid}}">
  <div class="form-row">
    <div class="form-group col-md-6">
      <label class="form-label">Désignation</label>
      <input type="text" name="modif_nom" class="form-control" id="modif_nom" placeholder="Ex: Coca Cola" value="{{article.nom}}" required>  
    </div>

    <div class="form-group col-md-6">
      <label class="form-label">Mesure</label>
      <input type="text" name="modif_mesure" class="form-control" id="modif_mesure" placeholder="Ex: 33 CL / 4 Kilos / 1h" value="{{article.mesure}}">
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label class="form-label">Type</label>
      <select name="modif_type" class="form-control default-select" id="modif_type" required>
        <option value="">-- Sélectionner --</option>
        <option value="BIE" {% if article.type == "BIE" %} selected {% endif %}>[BIE] Bien</option>
        <option value="SER" {% if article.type == "SER" %} selected {% endif %}>[SER] Service</option>

      </select>
    </div>

    <div class="form-group col-md-6">
      <label class="form-label">Catégorie</label>
      <div class="d-flex">
        <select name="modif_cat" class="form-control default-select" id="modif_categorie">
          <option value="">-- Sélectionner --</option>
          {% for i in categorie %}
            <option value="{{i.Uuid}}" {% if article.categorie == i.Libelle %} selected {% endif %}>{{i.Libelle}}</option>
          {% endfor %}
        </select>
        <button type="button" class="text-center ml-2 btn btn-xs px-1 py-1 light btn-success" data-toggle="modal" data-target="#modifcat">
          <i class="las la-plus" style="font-size: 18px;"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label class="form-label">Groupe</label>
      <select name="modif_groupe" class="form-control default-select" id="modif_groupe" required="Veuillez selectionner un groupe">
        <option value="">-- Sélectionner --</option>
        {% for i in groupe %}
          <!-- On stocke le taux dans un attribut data-taux -->
          <option value="{{i.Code}}" data-taux="{{i.Taux}}">{{i.Designation}} {{i.Taux}}%</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group col-md-6">
      <label class="form-label">Devise</label>
      <select name="modif_devise" class="form-control default-select" id="modif_devise" required>
        <option value="USD" {% if article.devise == 'USD' %} selected {% endif %}>USD</option>
        <option value="CDF" {% if article.devise == 'CDF' %} selected {% endif %}>CDF</option>
      </select>
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">Mode</label>
    <select name="modif_mode" class="form-control default-select" id="modif_mode" required>
      <option value="TTC" {% if article.mode == 'TTC' %} selected {% endif %}>TTC</option>
      <option value="HT" {% if article.mode == 'HT' %} selected {% endif %}>HT</option>
    </select>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="form-label">Prix [HT]</label>
      <input name="modif_prixht" type="number" step="0.01" class="form-control" id="modif_prixHT" placeholder="0.00" value="{{article.prixht}}">
    </div>
    <div class="col-md-6 mb-3">
      <label class="form-label">Prix [TTC]</label>
      <input name="modif_prixttc" type="number" step="0.01" class="form-control" id="modif_prixTTC" placeholder="0.00" readonly>
    </div>
  </div>

  <div class="form-check mb-3">
    <input class="form-check-input" type="checkbox" id="modif_taxe" name="modif_taxe">
    <label class="form-check-label" for="modif_taxe">Taxe spécifique</label>
  </div>

  <div id="taxeSection" class="border p-3 mb-3" style="display:none;">
    <div class="form-row">
      <div class="form-group col-md-6">
        <label class="form-label">Désignation</label>
        <input type="text" name="modif_specifique" class="form-control" id="modif_specifique">  
      </div>

      <div class="form-group col-md-6">
        <label class="form-label">Taux</label>
        <input type="number" name="modif_taux" class="form-control" id="modif_taux">
      </div>
    </div>
  </div>

  <div class="text-end">
    <button type="submit" class="btn btn-primary px-4">Valider</button>
  </div>
</form>

                                    </div>
                                </div>
                                <div class="modal fade" id="modifcat">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Nouvelle Catégorie</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span> </button>
                  </div>
                <div class="modal-body">
			          <form id="formArticle" action="{% url 'categorie' %}" method="post">
			            <div class="mb-3">
			            	{% csrf_token %}
			              <label class="form-label">Libellé</label>
			              <input type="hidden" name="usr" value="{{usr}}">
			              <input type="hidden" name="com" value="{{com}}">
			              <input type="text" name="lib" class="form-control" id="lib" placeholder="Ex: Boisson" required>
			            </div>
			            <div class="text-end">
			              <button type="submit" class="btn btn-primary px-4">AJOUTER</button>
			              <a href="/articles/?usr={{usr}}&com={{com}}" class="btn btn-light px-4">ANNULER</a>
			            </div>
			          </form>
               </div>
           </div>
       </div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const taxeCheckbox = document.getElementById('modif_taxe');
  const taxeSection = document.getElementById('taxeSection');
  const prixHT = document.getElementById('modif_prixHT');
  const prixTTC = document.getElementById('modif_prixTTC');
  const groupeSelect = document.getElementById('modif_groupe');

  // 1️⃣ Afficher ou cacher la section "taxe spécifique"
  taxeCheckbox.addEventListener('change', function () {
    taxeSection.style.display = this.checked ? 'block' : 'none';
  });

  // 2️⃣ Fonction de calcul du TTC
  function calculerTTC() {
    const ht = parseFloat(prixHT.value) || 0;
    const taux = parseFloat(groupeSelect.selectedOptions[0]?.getAttribute('data-taux')) || 0;
    const ttc = ht + (ht * taux * 0.01);
    prixTTC.value = ttc.toFixed(2);
  }

  // 3️⃣ Déclencher le calcul automatiquement
  prixHT.addEventListener('input', calculerTTC);
  groupeSelect.addEventListener('change', calculerTTC);
});
</script>
		</div>
	</div>

{% endblock %}